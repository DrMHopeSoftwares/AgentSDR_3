{% extends "layout.html" %}

{% block title %}Manage Organization - {{ organization.name }}{% endblock %}

{% block content %}
<div class="space-y-6" x-data="{ openCreateAgent: false, creating: false, agentName: '', agentType: 'email_summarizer', error: null }">
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-2xl font-bold text-secondary-900">{{ organization.name }}</h3>
                    <p class="mt-1 text-sm text-secondary-500">Slug: {{ organization.slug }}</p>
                </div>
                <div class="flex gap-2">
                    <a href="{{ url_for('orgs.edit_organization', org_slug=organization.slug) }}" class="btn btn-secondary">Edit</a>
                    <a href="{{ url_for('orgs.list_members', org_slug=organization.slug) }}" class="btn btn-secondary">Manage Users</a>
                    <a href="{{ url_for('orgs.list_agents', org_slug=organization.slug) }}" class="btn btn-secondary">All Agents</a>
                    <button class="btn btn-primary" @click="openCreateAgent = true">Create Agent</button>
                    <button class="btn btn-danger" onclick="deleteOrg('{{ organization.slug }}')">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-white shadow rounded-lg p-6">
            <div class="text-sm text-secondary-500">Members</div>
            <div class="text-2xl font-bold">{{ members_count }}</div>
        </div>
        <div class="bg-white shadow rounded-lg p-6">
            <div class="text-sm text-secondary-500">Records</div>
            <div class="text-2xl font-bold">{{ records_count }}</div>
        </div>
        <div class="bg-white shadow rounded-lg p-6">
            <div class="text-sm text-secondary-500">Pending Invites</div>
            <div class="text-2xl font-bold">{{ invites_count }}</div>
        </div>
    </div>

    {% if recent_records %}
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h4 class="text-lg font-medium text-secondary-900 mb-4">Recent Records</h4>
            <div class="space-y-2">
                {% for r in recent_records %}
                <div class="border rounded p-3">
                    <div class="flex justify-between">
                        <div>{{ r.title or 'Untitled' }}</div>
                        <div class="text-sm text-secondary-500">{{ r.created_at.split('T')[0] }}</div>
                    </div>
                    {% if r.content %}
                    <div class="text-sm text-secondary-600 mt-1">{{ r.content[:120] }}{% if r.content|length > 120 %}...{% endif %}</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

<!-- Create Agent Modal -->
<div x-cloak x-show="openCreateAgent" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center bg-black/30" @keydown.escape.window="openCreateAgent=false" @click.self="openCreateAgent=false">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl" @click.away="openCreateAgent = false">
        <div class="px-6 py-4 border-b flex justify-between items-center">
            <h3 class="text-lg font-medium">Build Agent</h3>
            <button class="text-secondary-500" @click="openCreateAgent = false">âœ•</button>
        </div>
        <div class="p-6 space-y-6">
            <div>
                <label class="block text-sm font-medium text-secondary-700 mb-1">Agent name</label>
                <input type="text" x-model="agentName" class="w-full border-secondary-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500" placeholder="e.g., Inbox Summarizer" />
            </div>
            <div>
                <style>
                    .option-active { box-shadow: 0 0 0 2px rgba(59,130,246,0.7); border-color: rgba(59,130,246,1); }
                </style>

                <label class="block text-sm font-medium text-secondary-700 mb-2">Choose a starting point</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button type="button" :aria-pressed="agentType==='email_summarizer'" :class="agentType==='email_summarizer' ? 'option-active' : ''" @click.stop="agentType='email_summarizer'" class="border rounded-lg p-4 text-left hover:border-secondary-400">
                        <div class="font-medium mb-1">Email summarizer</div>
                        <div class="text-sm text-secondary-600">Summarize emails automatically.</div>
                    </button>
                    <button type="button" :aria-pressed="agentType==='hubspot_data'" :class="agentType==='hubspot_data' ? 'option-active' : ''" @click.stop="agentType='hubspot_data'" class="border rounded-lg p-4 text-left hover:border-secondary-400">
                        <div class="font-medium mb-1">HubSpot data</div>
                        <div class="text-sm text-secondary-600">Connect and use HubSpot data.</div>
                    </button>
                    <button type="button" :aria-pressed="agentType==='custom'" :class="agentType==='custom' ? 'option-active' : ''" @click.stop="agentType='custom'" class="border rounded-lg p-4 text-left hover:border-secondary-400">
                        <div class="font-medium mb-1">Custom agent</div>
                        <div class="text-sm text-secondary-600">Start from scratch.</div>
                    </button>
                </div>
                <div class="sr-only">
                    <!-- Keep a hidden input bound to agentType to ensure value changes -->
                    <input type="text" x-model="agentType" />
                </div>

            </div>
            <template x-if="error">
                <div class="p-3 bg-red-100 text-red-700 rounded">{{ error }}</div>
            </template>
        </div>
        <div class="px-6 py-4 border-t flex justify-end gap-2">
            <button class="btn btn-secondary" @click="openCreateAgent = false">Cancel</button>
            <button class="btn btn-primary" :disabled="creating || !agentName" @click="
                creating=true; error=null;
                fetch('/orgs/{{ organization.slug }}/agents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: agentName, type: agentType })
                })
                .then(async r => {
                    const ct = r.headers.get('content-type') || '';
                    if (ct.includes('application/json')) {
                        const data = await r.json();
                        if (!r.ok && !data.error) data.error = `HTTP ${r.status}`;
                        return data;
                    } else {
                        const text = await r.text();
                        return { error: text || `HTTP ${r.status}` };
                    }
                })
                .then(d => {
                    if (d.error) { error=d.error; } else { openCreateAgent=false; agentName=''; agentType='email_summarizer'; showToast('Agent created', 'success'); }
                })
                .catch(e => { error='Failed to create agent'; console.error(e); })
                .finally(() => creating=false);
            ">Create</button>
        </div>
    </div>
</div>

<script>
async function deleteOrg(slug) {
    if (!confirm('Are you sure you want to delete this organization? This cannot be undone.')) return;
    try {
        const resp = await fetch(`/orgs/${slug}`, { method: 'DELETE' });
        const data = await resp.json();
        if (data.success) {
            window.location.href = '/orgs/mine';
        } else {
            alert(data.error || 'Failed to delete organization');
        }
    } catch (e) {
        console.error(e);
        alert('Failed to delete organization');
    }
}
</script>
{% endblock %}
